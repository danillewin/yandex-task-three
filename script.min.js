app={},app.vm={},app.getRandomInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a},Number.prototype.formatTime=function(){var a=Math.floor(this/3600),b=Math.floor((this-3600*a)/60),c=Math.floor(this-3600*a-60*b);return 10>b&&(b="0"+b),10>c&&(c="0"+c),b+":"+c};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,app.AudioContext=new AudioContext}catch(e){alert("Web Audio API is not supported in this browser")}!function(a){a.vm.TrackList=function(){var a=this;a.tracks=ko.observableArray([]),a.initDragDrop()},a.vm.TrackList.prototype.addTrack=function(b){var c,d,e,f,g=this,h="",i=new FileReader,j=a.AudioContext;ID3.loadTags(b,function(){if(c=ID3.getAllTags(b),c.picture){e=c.picture;for(var a=0;a<e.data.length;a++)h+=String.fromCharCode(e.data[a]);f="data:"+e.format+";base64,"+window.btoa(h)}else f="images/unknown.png";d={loaded:ko.observable(!1),artist:c.artist||"unknown",title:c.title||"unknown",album:c.album||"unknown",year:c.year,lyrics:c.lyrics,picture:f},i.onload=function(){j.decodeAudioData(i.result,function(a){d.loaded(!0),d.audio=a}),g.tracks.push(d)},i.readAsArrayBuffer(b)},{tags:["artist","title","album","year","lyrics","picture"],dataReader:FileAPIReader(b)})},a.vm.TrackList.prototype.initDragDrop=function(){var a=this,b=0;document.getElementsByClassName("track-list")[0].addEventListener("dragenter",function(a){b++,this.classList.add("track-list_dragover")}),document.getElementsByClassName("track-list")[0].addEventListener("dragleave",function(a){b--,0==b&&this.classList.remove("track-list_dragover")}),document.getElementsByClassName("track-list")[0].addEventListener("drop",function(c){var d=c.dataTransfer.files;b=0,c.preventDefault&&c.preventDefault(),this.classList.remove("track-list_dragover");for(var e in d)"object"==typeof d[e]&&d[e].type.indexOf("audio")>-1&&a.addTrack(d[e]);return!1}),document.getElementsByClassName("track-list")[0].addEventListener("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="copy",!1})},a.vm.TrackList.prototype.setTrack=function(b){var c=a.Player;c.currentTrack()!=b?c.setTrack(b):c.playing()?c.pause():c.play()},a.vm.TrackList.prototype.bindPlayer=function(){var b=this;b.currentTrack=a.Player.currentTrack,b.isPlaying=a.Player.playing}}(window.app),app.TrackList=new app.vm.TrackList,ko.applyBindings(app.TrackList,document.getElementsByClassName("track-list")[0]),function(a){a.vm.Player=function(){var b=this;b.context=a.AudioContext,b.gainNode=b.context.createGain(),b.equalizerNode=b.createFilters(),b.analyser=b.context.createAnalyser(),b.analyser.fftSize=256,b.canvasCtx=document.getElementsByClassName("js-visualization-canvas")[0].getContext("2d"),b.currentTime=ko.observable(0),b.playing=ko.observable(!1),b.volume=ko.observable(100),b.volumeBuffer,b.currentProgress=ko.observable(0),b.currentDuration=ko.observable(0),b.currentStartTime,b.currentProgressTime=ko.observable(0),b.seekTime=ko.observable(0),b.repeat=ko.observable(!0),b.shuffle=ko.observable(),b.currentTrack=ko.observable(),b.tracks=a.TrackList.tracks,b.tracksBuffer=[],b.chronometer,b.currentPreset=ko.observable("normal"),b.presets=[{name:"pop",values:[5,4,3,2,3,4,5]},{name:"rock",values:[4,2,0,2,2,0,1]},{name:"jazz",values:[6,1,4,2,0,5,1]},{name:"classic",values:[4,5,4,5,4,5,4]},{name:"normal",values:[0,0,0,0,0,0,0]}],b.volume.subscribe(function(a){b.gainNode.gain.value=a/100}),b.tracks.subscribe(function(){1==b.tracks().length&&b.currentTrack(b.tracks()[0])}),b.resolveVolumeClass=ko.computed(function(){var a=b.volume();return a>80?"up":80>=a&&a>0?"down":"off"}),b.bindProgressBar(),document.addEventListener("keyup",function(a){switch(a.which){case 32:b.playPause();break;case 37:b.prev();break;case 39:b.next()}}),document.getElementsByClassName("js-vol-btn")[0].addEventListener("wheel",function(a){a.deltaY>0?b.soundDown():b.soundUp()})},a.vm.Player.prototype.soundUp=function(){var a=this;a.volume()<=90?a.volume(a.volume()+10):a.volume(100)},a.vm.Player.prototype.soundDown=function(){var a=this;a.volume()>=10?a.volume(a.volume()-10):a.volume(0)},a.vm.Player.prototype.bindProgressBar=function(){var a=this,b=document.getElementsByClassName("js-control-progress")[0],c=(document.getElementsByClassName("js-control-progress-inner")[0],document.getElementsByClassName("js-control-progress-input")[0],document.getElementsByClassName("js-control-progress-seek")[0]);b.addEventListener("click",function(b){a.setTime(a.seekTime())},!1),b.addEventListener("mousemove",function(d){a.seekTime(Math.floor(d.offsetX/b.offsetWidth*a.currentDuration())),c.style.width=d.offsetX+"px"},!1),b.addEventListener("mousedown",function(d){a.seekTime(Math.floor(d.offsetX/b.offsetWidth*a.currentDuration())),c.style.width=d.offsetX+"px"},!1),b.addEventListener("mouseout",function(a){c.style.width="0px"},!1)},a.vm.Player.prototype.playPause=function(){var a=this;a.playing()?a.pause():a.play()},a.vm.Player.prototype.play=function(){var a=this;a.currentTrack().loaded()?(a.source=a.context.createBufferSource(),a.source.buffer=a.currentTrack().audio,a.source.connect(a.gainNode),a.gainNode.connect(a.equalizerNode[0]),a.equalizerNode[a.equalizerNode.length-1].connect(a.context.destination),a.equalizerNode[a.equalizerNode.length-1].connect(a.analyser),0==a.currentProgressTime()&&(a.currentStartTime=a.context.currentTime,a.currentDuration(a.source.buffer.duration)),a.source.start(0,a.currentProgressTime()),a.playing(!0),a.visualize(),a.source.onended=a.onEnd.bind(a),a.startChronometer()):console.log("Upload the track first")},a.vm.Player.prototype.pause=function(){var a=this;a.source.stop(),a.playing(!1),a.killChronometer()},a.vm.Player.prototype.next=function(){var a,b=this,c=b.tracks(),d=c.length;if(a=c.indexOf(b.currentTrack())+1,a>=d){if(!b.repeat())return b.stop(),void b.currentTrack(b.tracks()[0]);b.setTrack(c[0])}else b.setTrack(c[a])},a.vm.Player.prototype.prev=function(){var a,b=this,c=b.tracks(),d=c.length;if(b.currentProgressTime()>=5)return b.stop(),void b.play();if(a=c.indexOf(b.currentTrack())-1,0>a){if(!b.repeat())return b.stop(),void b.currentTrack(b.tracks()[0]);b.setTrack(c[d-1])}else b.setTrack(c[a])},a.vm.Player.prototype.stop=function(){var a=this;a.source.stop(),a.playing(!1),a.killChronometer(),a.currentProgress(0),a.currentProgressTime(0)},a.vm.Player.prototype.setTrack=function(a){var b=this;b.playing()&&b.stop(),b.currentTrack(a),b.play()},a.vm.Player.prototype.setTime=function(a){var b=this;b.pause(),b.currentProgressTime(a),b.play()},a.vm.Player.prototype.onEnd=function(){var a=this;Math.ceil(a.currentProgressTime())>=Math.floor(a.currentDuration())&&a.next()},a.vm.Player.prototype.visualize=function(){var a=this,b=a.analyser.frequencyBinCount,c=new Uint8Array(b),d=a.canvasCtx.canvas.width,e=a.canvasCtx.canvas.height;cancelAnimationFrame(a.drawAnimationId);var f=function(){var g,h=Math.floor(d/b*2),i=0;a.drawAnimationId=requestAnimationFrame(f),a.analyser.getByteFrequencyData(c),a.canvasCtx.clearRect(0,0,d,e);for(var j=0;b>j;j++)g=Math.floor(c[j]/2)+2,a.canvasCtx.fillStyle="rgb(255,0,0)",a.canvasCtx.fillRect(i,e-g,h,g),i+=h+1};f()},a.vm.Player.prototype.toggleMute=function(){var a=this,b=a.volume();b>0?(a.volumeBuffer=b,a.volume(0)):a.volume(a.volumeBuffer)},a.vm.Player.prototype.toggleRepeat=function(){var a=this;a.repeat(!a.repeat())},a.vm.Player.prototype.toggleShuffle=function(){var b=this;b.shuffle(!b.shuffle()),b.shuffle()?(b.tracksBuffer=b.tracks().slice(0),b.tracks(b.tracks().sort(function(){return a.getRandomInt(0,1)}))):b.tracks(b.tracksBuffer)},a.vm.Player.prototype.startChronometer=function(){var a,b=this,c=b.currentDuration();0!=b.currentProgressTime()&&(b.currentStartTime=b.context.currentTime-b.currentProgressTime()),a=b.currentStartTime,b.chronometer=setInterval(function(){var d=b.context.currentTime;b.currentProgressTime(d-a),b.currentProgress(b.currentProgressTime()/c*100)},300)},a.vm.Player.prototype.killChronometer=function(){var a=this;clearInterval(a.chronometer)},a.vm.Player.prototype.createFilter=function(a){var b=this,c=b.context.createBiquadFilter();return c.type="peaking",c.frequency.value=a,c.Q.value=1,c.value=ko.observable(),c.value.subscribe(function(a){c.gain.value=a}),c.value(0),c},a.vm.Player.prototype.createFilters=function(){var a=this,b=[60,310,600,1e3,6e3,14e3,16e3],c=b.map(a.createFilter.bind(a));return c.reduce(function(a,b){return a.connect(b),b}),c},a.vm.Player.prototype.setEqualizer=function(a){var b=this,c=[];c=b.presets.filter(function(b){return b.name==a.name})[0].values,b.currentPreset(a.name);for(var d=0;d<b.equalizerNode.length;d++)b.equalizerNode[d].value(c[d])}}(window.app),app.Player=new app.vm.Player,app.TrackList.bindPlayer(),ko.applyBindings(app.Player,document.getElementsByClassName("controls")[0]);
//# sourceMappingURL=script.map
