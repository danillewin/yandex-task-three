app={},app.vm={};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,app.AudioContext=new AudioContext}catch(e){alert("Web Audio API is not supported in this browser")}!function(a){a.vm.TrackList=function(){var a=this;a.tracks=ko.observableArray([]),a.initDragDrop()},a.vm.TrackList.prototype.addTrack=function(b){var c,d,e,f,g=this,h="",i=new FileReader,j=a.AudioContext;ID3.loadTags(b,function(){if(c=ID3.getAllTags(b),c.picture){e=c.picture;for(var a=0;a<e.data.length;a++)h+=String.fromCharCode(e.data[a]);f="data:"+e.format+";base64,"+window.btoa(h)}else f="images/unknown.png";d={artist:c.artist||"unknown",title:c.title||"unknown",album:c.album||"unknown",year:c.year,lyrics:c.lyrics,picture:f},i.onload=function(){j.decodeAudioData(i.result,function(a){d.audio=a}),g.tracks.push(d)},i.readAsArrayBuffer(b)},{tags:["artist","title","album","year","lyrics","picture"],dataReader:FileAPIReader(b)})},a.vm.TrackList.prototype.initDragDrop=function(){var a=this;document.getElementsByClassName("track-list")[0].addEventListener("dragenter",function(a){this.classList.add("track-list_dragover")}),document.getElementsByClassName("track-list")[0].addEventListener("dragleave",function(a){this.classList.remove("track-list_dragover")}),document.getElementsByClassName("track-list")[0].addEventListener("drop",function(b){b.preventDefault&&b.preventDefault(),this.classList.remove("track-list_dragover");for(var c in b.dataTransfer.files)a.addTrack(b.dataTransfer.files[c]);return!1}),document.getElementsByClassName("track-list")[0].addEventListener("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="copy",!1})}}(window.app),app.TrackList=new app.vm.TrackList,ko.applyBindings(app.TrackList,document.getElementsByClassName("track-list")[0]),function(a){a.vm.Player=function(){var b=this;b.context=a.AudioContext,b.gainNode=b.context.createGain(),b.analyser=b.context.createAnalyser(),b.analyser.fftSize=256,b.canvasCtx=document.getElementsByClassName("js-visualization-canvas")[0].getContext("2d"),b.currentTime=ko.observable(0),b.playing=ko.observable(!1),b.volume=ko.observable(100),b.volumeBuffer,b.repeat=ko.observable(!0),b.shuffle=ko.observable(),b.equalizer=ko.observable(),b.currentTrack=ko.observable(),b.tracks=a.TrackList.tracks,b.presets={jazz:"",normal:"",rock:"",pop:""},b.volume.subscribe(function(a){b.gainNode.gain.value=a/100}),b.tracks.subscribe(function(){1==b.tracks().length&&b.currentTrack(b.tracks()[0])}),b.resolveVolumeClass=ko.computed(function(){var a=b.volume();return a>50?"up":50>=a&&a>0?"down":"off"})},a.vm.Player.prototype.playPause=function(){var a=this;a.playing()?a.pause():a.play()},a.vm.Player.prototype.play=function(){var a=this;a.currentTrack()?(a.source=a.context.createBufferSource(),a.source.buffer=a.currentTrack().audio,a.source.connect(a.gainNode),a.gainNode.connect(a.context.destination),a.source.start(0),a.playing(!0),a.visualize()):alert("Upload the track first")},a.vm.Player.prototype.pause=function(){var a=this;a.source.stop(),a.playing(!1)},a.vm.Player.prototype.next=function(){var a,b=this,c=b.tracks(),d=c.length;if(a=c.indexOf(b.currentTrack())+1,a>=d){if(!b.repeat())return;b.setTrack(c[0])}else b.setTrack(c[a])},a.vm.Player.prototype.prev=function(){var a,b=this,c=b.tracks(),d=c.length;if(a=c.indexOf(b.currentTrack())-1,0>a){if(!b.repeat())return;b.setTrack(c[d-1])}else b.setTrack(c[a])},a.vm.Player.prototype.stop=function(){var a=this;a.source.stop(),a.playing(!1)},a.vm.Player.prototype.setTrack=function(a){var b=this;b.stop(),b.currentTrack(a),b.play()},a.vm.Player.prototype.visualize=function(){var a=this,b=a.analyser.frequencyBinCount,c=new Uint8Array(b),d=a.canvasCtx.canvas.width,e=a.canvasCtx.canvas.height;a.gainNode.connect(a.analyser);var f=function(){var g,h,i=Math.floor(d/b*2),j=0;if(a.playing()){h=requestAnimationFrame(f),a.analyser.getByteFrequencyData(c),a.canvasCtx.clearRect(0,0,d,e);for(var k=0;b>k;k++)g=Math.floor(c[k]/2),a.canvasCtx.fillStyle="rgb(255,0,0)",a.canvasCtx.fillRect(j,e-g,i,g),j+=i+1}else for(var k=0;b>k;k++)a.canvasCtx.fillStyle="rgb(255,0,0)",a.canvasCtx.fillRect(j,0,i,0),j+=i+1};f()},a.vm.Player.prototype.toggleMute=function(){var a=this,b=a.volume();b>0?(a.volumeBuffer=b,a.volume(0)):a.volume(a.volumeBuffer)},a.vm.Player.prototype.toggleRepeat=function(){var a=this;a.repeat(!a.repeat())}}(window.app),app.Player=new app.vm.Player,ko.applyBindings(app.Player,document.getElementsByClassName("controls")[0]);
//# sourceMappingURL=script.map
