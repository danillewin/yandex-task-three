app={},app.vm={},app.getRandomInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a},Number.prototype.formatTime=function(){var a=Math.floor(this/3600),b=Math.floor((this-3600*a)/60),c=Math.floor(this-3600*a-60*b);return 10>b&&(b="0"+b),10>c&&(c="0"+c),b+":"+c};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,app.AudioContext=new AudioContext}catch(e){alert("Web Audio API is not supported in this browser")}!function(a){a.vm.TrackList=function(){var a=this;a.tracks=ko.observableArray([]),a.initDragDrop()},a.vm.TrackList.prototype.addTrack=function(b){var c,d,e,f,g=this,h="",i=new FileReader,j=a.AudioContext;ID3.loadTags(b,function(){if(c=ID3.getAllTags(b),c.picture){e=c.picture;for(var a=0;a<e.data.length;a++)h+=String.fromCharCode(e.data[a]);f="data:"+e.format+";base64,"+window.btoa(h)}else f="images/unknown.png";d={artist:c.artist||"unknown",title:c.title||"unknown",album:c.album||"unknown",year:c.year,lyrics:c.lyrics,picture:f},i.onload=function(){j.decodeAudioData(i.result,function(a){d.audio=a}),g.tracks.push(d)},i.readAsArrayBuffer(b)},{tags:["artist","title","album","year","lyrics","picture"],dataReader:FileAPIReader(b)})},a.vm.TrackList.prototype.initDragDrop=function(){var a=this;document.getElementsByClassName("track-list")[0].addEventListener("dragenter",function(a){this.classList.add("track-list_dragover")}),document.getElementsByClassName("track-list")[0].addEventListener("dragleave",function(a){this.classList.remove("track-list_dragover")}),document.getElementsByClassName("track-list")[0].addEventListener("drop",function(b){var c=b.dataTransfer.files;b.preventDefault&&b.preventDefault(),this.classList.remove("track-list_dragover");for(var d in c)"object"==typeof c[d]&&"audio/mp3"==c[d].type&&a.addTrack(c[d]);return!1}),document.getElementsByClassName("track-list")[0].addEventListener("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="copy",!1})},a.vm.TrackList.prototype.setTrack=function(b){var c=a.Player;c.currentTrack()!=b?c.setTrack(b):c.playing()?c.pause():c.play()},a.vm.TrackList.prototype.bindPlayer=function(){var b=this;b.currentTrack=a.Player.currentTrack,b.isPlaying=a.Player.playing}}(window.app),app.TrackList=new app.vm.TrackList,ko.applyBindings(app.TrackList,document.getElementsByClassName("track-list")[0]),function(a){a.vm.Player=function(){var b=this;b.context=a.AudioContext,b.gainNode=b.context.createGain(),b.equalizerNode=b.createFilters(),b.analyser=b.context.createAnalyser(),b.analyser.fftSize=256,b.canvasCtx=document.getElementsByClassName("js-visualization-canvas")[0].getContext("2d"),b.currentTime=ko.observable(0),b.playing=ko.observable(!1),b.volume=ko.observable(100),b.volumeBuffer,b.currentProgress=ko.observable(0),b.currentDuration=ko.observable(0),b.currentStartTime,b.currentProgressTime=ko.observable(0),b.repeat=ko.observable(!0),b.shuffle=ko.observable(),b.currentTrack=ko.observable(),b.tracks=a.TrackList.tracks,b.tracksBuffer=[],b.chronometer,b.currentPreset=ko.observable("normal"),b.presets=[{name:"pop",values:[5,4,3,2,3,4,5]},{name:"rock",values:[4,2,0,2,2,0,1]},{name:"jazz",values:[6,1,4,2,0,5,1]},{name:"classic",values:[4,5,4,5,4,5,4]},{name:"normal",values:[0,0,0,0,0,0,0]}],b.volume.subscribe(function(a){b.gainNode.gain.value=a/100}),b.tracks.subscribe(function(){1==b.tracks().length&&b.currentTrack(b.tracks()[0])}),b.resolveVolumeClass=ko.computed(function(){var a=b.volume();return a>80?"up":80>=a&&a>0?"down":"off"}),b.bindProgressBar()},a.vm.Player.prototype.bindProgressBar=function(){var a,b=this,c=document.getElementsByClassName("js-control-progress")[0];document.getElementsByClassName("js-control-progress-inner")[0],document.getElementsByClassName("js-control-progress-input")[0];c.addEventListener("click",function(d){a=Math.floor(d.offsetX/c.offsetWidth*100),b.setTime(a)},!1)},a.vm.Player.prototype.playPause=function(){var a=this;a.playing()?a.pause():a.play()},a.vm.Player.prototype.play=function(){var a=this;a.currentTrack()?(a.source=a.context.createBufferSource(),a.source.buffer=a.currentTrack().audio,a.source.connect(a.gainNode),a.gainNode.connect(a.equalizerNode[0]),a.equalizerNode[a.equalizerNode.length-1].connect(a.context.destination),0==a.currentProgressTime()&&(a.currentStartTime=a.context.currentTime,a.currentDuration(a.source.buffer.duration)),a.source.start(0,a.currentProgressTime()),a.playing(!0),a.source.onended=a.onEnd.bind(a),a.startChronometer(),a.visualize()):alert("Upload the track first")},a.vm.Player.prototype.pause=function(){var a=this;a.source.stop(),a.playing(!1),a.killChronometer()},a.vm.Player.prototype.next=function(){var a,b=this,c=b.tracks(),d=c.length;if(a=c.indexOf(b.currentTrack())+1,a>=d){if(!b.repeat())return b.stop(),void b.currentTrack(b.tracks()[0]);b.setTrack(c[0])}else b.setTrack(c[a])},a.vm.Player.prototype.prev=function(){var a,b=this,c=b.tracks(),d=c.length;if(a=c.indexOf(b.currentTrack())-1,0>a){if(!b.repeat())return;b.setTrack(c[d-1])}else b.setTrack(c[a])},a.vm.Player.prototype.stop=function(){var a=this;a.source.stop(),a.playing(!1),a.killChronometer(),a.currentProgress(0),a.currentProgressTime(0)},a.vm.Player.prototype.setTrack=function(a){var b=this;b.stop(),b.currentTrack(a),b.play()},a.vm.Player.prototype.setTime=function(a){var b=this,c=b.currentDuration()/100*a;b.stop(),b.currentProgressTime(c),b.play()},a.vm.Player.prototype.onEnd=function(){var a=this;Math.floor(a.currentProgressTime())>=Math.floor(a.currentDuration())&&a.next()},a.vm.Player.prototype.visualize=function(){var a=this,b=a.analyser.frequencyBinCount,c=new Uint8Array(b),d=a.canvasCtx.canvas.width,e=a.canvasCtx.canvas.height;a.equalizerNode[a.equalizerNode.length-1].connect(a.analyser);var f=function(){var g,h,i=Math.floor(d/b*2),j=0;if(a.playing()){h=requestAnimationFrame(f),a.analyser.getByteFrequencyData(c),a.canvasCtx.clearRect(0,0,d,e);for(var k=0;b>k;k++)g=Math.floor(c[k]/2),a.canvasCtx.fillStyle="rgb(255,0,0)",a.canvasCtx.fillRect(j,e-g,i,g),j+=i+1}else for(var k=0;b>k;k++)a.canvasCtx.fillStyle="rgb(255,0,0)",a.canvasCtx.fillRect(j,0,i,0),j+=i+1};f()},a.vm.Player.prototype.toggleMute=function(){var a=this,b=a.volume();b>0?(a.volumeBuffer=b,a.volume(0)):a.volume(a.volumeBuffer)},a.vm.Player.prototype.toggleRepeat=function(){var a=this;a.repeat(!a.repeat())},a.vm.Player.prototype.toggleShuffle=function(){var b=this;b.shuffle(!b.shuffle()),b.shuffle()?(b.tracksBuffer=b.tracks().slice(0),b.tracks(b.tracks().sort(function(){return a.getRandomInt(0,1)}))):b.tracks(b.tracksBuffer)},a.vm.Player.prototype.startChronometer=function(){var a,b=this,c=b.currentDuration();0!=b.currentProgressTime()&&(b.currentStartTime=b.context.currentTime-b.currentProgressTime()),a=b.currentStartTime,b.chronometer=setInterval(function(){var d=b.context.currentTime;b.currentProgressTime(d-a),b.currentProgress(b.currentProgressTime()/c*100)},300)},a.vm.Player.prototype.killChronometer=function(){var a=this;clearInterval(a.chronometer)},a.vm.Player.prototype.createFilter=function(a){var b=this,c=b.context.createBiquadFilter();return c.type="peaking",c.frequency.value=a,c.Q.value=1,c.value=ko.observable(),c.value.subscribe(function(a){c.gain.value=a}),c.value(0),c},a.vm.Player.prototype.createFilters=function(){var a=this,b=[60,310,600,1e3,6e3,14e3,16e3],c=b.map(a.createFilter.bind(a));return c.reduce(function(a,b){return a.connect(b),b}),c},a.vm.Player.prototype.setEqualizer=function(a){var b=this,c=[];c=b.presets.filter(function(b){return b.name==a.name})[0].values,b.currentPreset(a.name);for(var d=0;d<b.equalizerNode.length;d++)b.equalizerNode[d].value(c[d])}}(window.app),app.Player=new app.vm.Player,app.TrackList.bindPlayer(),ko.applyBindings(app.Player,document.getElementsByClassName("controls")[0]);
//# sourceMappingURL=script.map
